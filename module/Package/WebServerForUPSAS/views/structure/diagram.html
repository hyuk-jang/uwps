<!DOCTYPE html>
<html>

<head>
    <%- include("../master/head.html") %>
    <script type="text/javascript" src="js/svg.js"></script>
    <script type="text/javascript" src="js/svg.filter.js"></script>
    <script type="text/javascript" src="js/jquery.panzoom.js"></script>
    <script type="text/javascript" src="js/contents/svgMap/drawSvg.js"></script>
    <script type="text/javascript" src="js/config/upsasConfig.js"></script>
    <style>
    </style>
</head>

<body>
    <!--네비-->
    <%- include("../master/header.html") %>
    <!--메인-->
    <div class="jumbotron text-center jumbotron_line">
        <div class="row row_st_line min_h_780">
            <div id="zoom" style="display: flex; justify-content: center;">
                <button id="zoom-in" class="btn btn-default btn-sm" style="margin-right: 5px"><span class="glyphicon glyphicon-zoom-in"></span>
                    Zoom-in</button>
                <button id="zoom-out" class="btn btn-default btn-sm" style="margin-right: 5px"><span class="glyphicon glyphicon-zoom-out"></span>
                    Zoom-out</button>
                <button id="reset" class="btn btn-default btn-sm" style="margin-right: 5px"><span class="glyphicon glyphicon-refresh"></span>
                    Reset</button>
            </div>
            <!-- canvas -->
            <div>
                <div id="canvas" style=" display: flex; justify-content: center; margin: 5px"></div>
            </div>
        </div>
    </div>


    <script>
        var map = <%- JSON.stringify(map) %>
        drawSvgBasePlace('canvas');

        // size 재설정
        var svgMap = SVG.get('svgCanvas');
        var canvas = document.getElementById('canvas');
        canvas.style.width = svgMap.node.width.baseVal.value + 'px';
        canvas.style.height = svgMap.node.height.baseVal.value + 'px';
        var $canvas = $('#canvas')
        var matrix = 'matrix(0.4, 0, 0, 0.4, -850, -600)'

        var filter = "win16|win32|win64|mac";
        if (navigator.platform) {
            if (0 > filter.indexOf(navigator.platform.toLowerCase())) {
                // mobile
                // panzoom
                $canvas.panzoom({
                    disablePan: true,
                    disableZoom: true,
                    startTransform: matrix,
                })
                $('#zoom-out', '#zoom-in', '#reset').hide()
            } else {
                // pc
                // panzoom
                $canvas.panzoom({
                    $reset: $('#reset'),
                    cursor: "context-menu",
                    startTransform: matrix,
                })

                // mouseWheel
                $canvas.panzoom().on('mousewheel.focal', function (e) {
                    e.preventDefault();
                    var delta = e.delta || e.originalEvent.wheelDelta;
                    var zoomOut = delta ? delta < 0 : e.originalEvent.deltaY > 0;
                    $canvas.panzoom('zoom', zoomOut, {
                        animate: false,
                        focal: e
                    });
                })

                // zoom 기능 기준점 재정의
                $('#zoom-in').click(function (e) {
                    e.clientX = 300;
                    e.clientY = 200;
                    $canvas.panzoom('zoom', {
                        // focal: e
                    });
                });
                $('#zoom-out').click(function (e) {
                    e.clientX = 300;
                    e.clientY = 200;
                    $canvas.panzoom('zoom', 'zoomOut', {
                        focal: e,
                    });
                });
            }
        }
    </script>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        $(function () {
            var socket = io();
            // 접속한 사용자의 정보를 보내줌.
            socket.emit("certifySocket", {
                sessionID: "<%- sessionID %>",
                sessionUserInfo: <%- JSON.stringify(user) %>
            });

            // 노드 관련 갱신 반영
            socket.on("updateNodeInfo", function (nodeList) {
                _.forEach(nodeList, nodeInfo => {
                    // console.log(nodeInfo.node_id, nodeInfo.data)
                    showNodeData(nodeInfo.node_id, nodeInfo.data)
                })
                // $MS_node_table.bootstrapTable('destroy').bootstrapTable({
                //     data: nodeList
                // });
                // document.getElementById("CMD_node_date").innerText = new Date().toLocaleString();
            });

        })
    </script>

    <%- include("../master/footer.html") %>
</body>

</html>